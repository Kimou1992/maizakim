<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>حفظ البيانات في الذاكرة المحلية</title>
  <script>
    // دالة لتحديث البيانات في الذاكرة المحلية (localStorage)
    function saveToLocalStorage() {
      var id = document.getElementById("id").value;
      var ad = document.getElementById("ad").value;

      // التحقق من وجود قيم في الحقول
      if (id && ad) {
        localStorage.setItem("id", id);
        localStorage.setItem("ad", ad);
        alert("تم حفظ التحديثات في الذاكرة المحلية.");
      } else {
        alert("الرجاء إدخال ID و Ad.");
      }
    }

    // دالة للتحقق من الاتصال بالإنترنت وإرسال البيانات تلقائيًا عبر التريجر باستخدام AJAX
    function checkAndSendUpdates() {
      if (navigator.onLine) { // تحقق من الاتصال بالإنترنت
        var id = localStorage.getItem("id");
        var ad = localStorage.getItem("ad");

        // التحقق من وجود بيانات في الذاكرة المحلية
        if (id && ad) {
          // إعداد البيانات لإرسالها عبر AJAX
          var action = "update"; // الإجراء المطلوب
          var params = "action=" + action + "&id=" + id + "&ad=" + ad;

          var url = "https://script.google.com/macros/s/AKfycbz1gEZPcbk5eCapMjr4PmUwQyQXGfE6b6ZoHGtE0-GtNx7HMlQ4tppnw7xX-9wP6TmOVQ/exec"; // رابط الـ Google Apps Script

          // إنشاء طلب AJAX باستخدام XMLHttpRequest
          var xhr = new XMLHttpRequest();
          xhr.open("POST", url, true);
          xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

          xhr.onload = function() {
            if (xhr.status === 200) {
              // رسالة عند نجاح الإرسال
              alert("تم إرسال التحديثات إلى الشيت بنجاح.");
              console.log("تم إرسال التحديثات بنجاح: " + xhr.responseText);

              // بعد الإرسال، حذف البيانات من الذاكرة المحلية
              localStorage.removeItem("id");
              localStorage.removeItem("ad");
              console.log("تم حذف البيانات من الذاكرة المحلية.");
            } else {
              // رسالة في حالة حدوث خطأ في الإرسال
              console.error("حدث خطأ في الإرسال: " + xhr.status);
              alert("حدث خطأ في إرسال البيانات.");
            }
          };

          // إرسال البيانات عبر AJAX
          xhr.onerror = function() {
            console.error("حدث خطأ في إرسال الطلب.");
            alert("حدث خطأ في الاتصال.");
          };
          
          xhr.send(params); // إرسال البيانات في الـ body
        }
      }
    }

    // دالة لإعداد التريجر الذي يعمل كل دقيقة
    function setTrigger() {
      setInterval(checkAndSendUpdates, 60000); // التريجر يعمل كل دقيقة (60000 ملي ثانية)
    }

    // تفعيل التريجر عند تحميل الصفحة
    window.onload = function() {
      setTrigger(); // تفعيل التريجر عند تحميل الصفحة
    };
  </script>
</head>
<body>
  <h1>حفظ البيانات في الذاكرة المحلية</h1>
  <div>
    <label for="id">ID:</label>
    <input type="text" id="id" name="id" required><br><br>
    <label for="ad">Ad:</label>
    <input type="text" id="ad" name="ad" required><br><br>
    <button onclick="saveToLocalStorage()">حفظ التحديثات في الذاكرة</button>
  </div>
</body>
</html>
