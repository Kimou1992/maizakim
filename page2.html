<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegram Mini App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 50px;
    }

    #countdown {
      font-size: 36px;
      color: #333;
      margin: 20px 0;
    }

    .status {
      font-size: 18px;
      color: green;
    }

    input, button {
      font-size: 18px;
      margin: 10px;
      padding: 10px;
    }
  </style>
  <script>
    // التحقق عند فتح التطبيق
    function checkTelegramId() {
      const storedId = localStorage.getItem("telegramId"); // البحث عن ID في الذاكرة المحلية

      if (storedId) {
        console.log("تم العثور على Telegram ID في الذاكرة المحلية:", storedId);
        document.getElementById("status").textContent = `مرحبا! معرفك: ${storedId}`;
      } else {
        // إذا لم يكن هناك ID، يتم الحصول عليه من Telegram Web Apps SDK
        const telegram = window.Telegram.WebApp;
        const userId = telegram.initDataUnsafe?.user?.id;

        if (userId) {
          localStorage.setItem("telegramId", userId); // تخزين Telegram ID في الذاكرة المحلية
          console.log("تم حفظ Telegram ID في الذاكرة المحلية:", userId);
          document.getElementById("status").textContent = `تم حفظ معرفك: ${userId}`;
        } else {
          console.error("تعذر الحصول على معرف Telegram ID.");
          document.getElementById("status").textContent = "حدث خطأ في جلب معرفك من Telegram.";
        }
      }
    }

    // بدء العداد التنازلي
    function startCountdown() {
      const countdownElement = document.getElementById("countdown");
      const statusElement = document.getElementById("status");

      function updateCountdown() {
        const now = new Date();
        const seconds = now.getSeconds();

        // حساب الوقت المتبقي حتى 31 ثانية من الدقيقة الموالية
        let remainingSeconds = 31 - seconds;
        if (remainingSeconds < 0) {
          remainingSeconds += 60; // إعادة العد من 60
        }

        // تحديث واجهة المستخدم
        countdownElement.textContent = `00:00:${String(remainingSeconds).padStart(2, "0")}`;

        // إذا وصل إلى 31 ثانية، تشغيل التريجر الافتراضي
        if (remainingSeconds === 0) {
          statusElement.textContent = "تم تشغيل التريجر الآن!";
          sendUpdates(); // إرسال البيانات عند التريجر
          setTimeout(() => (statusElement.textContent = ""), 2000); // مسح الرسالة بعد ثانيتين
        }
      }

      // تحديث العداد كل ثانية
      setInterval(updateCountdown, 1000);
    }

    // حفظ البيانات في الذاكرة المحلية
    function saveToLocalStorage() {
      const id = localStorage.getItem("telegramId"); // استخدام Telegram ID من الذاكرة
      const ad = document.getElementById("ad").value;

      if (id && ad) {
        localStorage.setItem("ad", ad);
        alert("تم حفظ التحديثات في الذاكرة المحلية.");
      } else {
        alert("الرجاء إدخال Ad. معرفك مسجل بالفعل.");
      }
    }

    // إرسال البيانات تلقائيًا عند التريجر
    function sendUpdates() {
      if (navigator.onLine) { // تحقق من الاتصال بالإنترنت
        const id = localStorage.getItem("telegramId");
        const ad = localStorage.getItem("ad");

        if (id && ad) {
          const action = "update"; // الإجراء المطلوب
          const params = "action=" + action + "&id=" + id + "&ad=" + ad;

          const url = "https://script.google.com/macros/s/AKfycbz1gEZPcbk5eCapMjr4PmUwQyQXGfE6b6ZoHGtE0-GtNx7HMlQ4tppnw7xX-9wP6TmOVQ/exec"; // رابط الـ Google Apps Script

          const xhr = new XMLHttpRequest();
          xhr.open("POST", url, true);
          xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

          xhr.onload = function() {
            if (xhr.status === 200) {
              alert("تم إرسال التحديثات إلى الشيت بنجاح.");
              localStorage.removeItem("ad"); // حذف البيانات من الذاكرة بعد الإرسال
            } else {
              alert("حدث خطأ في إرسال البيانات.");
            }
          };

          xhr.onerror = function() {
            alert("حدث خطأ في الاتصال.");
          };

          xhr.send(params);
        }
      }
    }

    // عند تحميل الصفحة
    window.onload = function() {
      checkTelegramId(); // التحقق من Telegram ID
      startCountdown(); // بدء العداد التنازلي
    };
  </script>
</head>
<body>
  <h1>Telegram Mini App</h1>
  <div id="status" class="status"></div>
  <div>
    <label for="ad">Ad:</label>
    <input type="text" id="ad" name="ad" required><br><br>
    <button onclick="saveToLocalStorage()">حفظ Ad في الذاكرة</button>
  </div>
  <div id="countdown">00:00:00</div>
</body>
</html>
