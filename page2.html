<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>عداد تنازلي مع تخزين البيانات</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 50px;
    }

    #countdown {
      font-size: 36px;
      color: #333;
      margin: 20px 0;
    }

    .status {
      font-size: 18px;
      color: green;
    }

    input, button {
      font-size: 18px;
      margin: 10px;
      padding: 10px;
    }
  </style>
  <script>
    // دالة لحساب العد التنازلي بناءً على الوقت الفعلي
    function startCountdown() {
      const countdownElement = document.getElementById("countdown");
      const statusElement = document.getElementById("status");

      function updateCountdown() {
        const now = new Date();
        const seconds = now.getSeconds();

        // حساب الوقت المتبقي حتى 31 ثانية من الدقيقة الموالية
        let remainingSeconds = 31 - seconds;
        if (remainingSeconds < 0) {
          remainingSeconds += 60; // إعادة العد من 60
        }

        // تحديث واجهة المستخدم
        countdownElement.textContent = `00:00:${String(remainingSeconds).padStart(2, "0")}`;

        // إذا وصل إلى 31 ثانية، تشغيل التريجر الافتراضي
        if (remainingSeconds === 0) {
          statusElement.textContent = "تم تشغيل التريجر الآن!";
          sendUpdates(); // إرسال البيانات عند التريجر
          setTimeout(() => (statusElement.textContent = ""), 2000); // مسح الرسالة بعد ثانيتين
        }
      }

      // تحديث العداد كل ثانية
      setInterval(updateCountdown, 1000);
    }

    // دالة لتحديث البيانات في الذاكرة المحلية (localStorage)
    function saveToLocalStorage() {
      const ad = document.getElementById("ad").value;

      // التحقق من وجود قيم في الحقول
      if (ad) {
        localStorage.setItem("ad", ad);
        alert("تم حفظ التحديثات في الذاكرة المحلية.");
      } else {
        alert("الرجاء إدخال Ad.");
      }
    }

    // دالة لإرسال البيانات تلقائيًا عند التريجر
    function sendUpdates() {
      if (navigator.onLine) { // تحقق من الاتصال بالإنترنت
        const id = localStorage.getItem("id");
        const ad = localStorage.getItem("ad");

        // التحقق من وجود بيانات في الذاكرة المحلية
        if (id && ad) {
          const action = "update"; // الإجراء المطلوب
          const params = "action=" + action + "&id=" + id + "&ad=" + ad;

          const url = "https://script.google.com/macros/s/AKfycbz1gEZPcbk5eCapMjr4PmUwQyQXGfE6b6ZoHGtE0-GtNx7HMlQ4tppnw7xX-9wP6TmOVQ/exec"; // رابط الـ Google Apps Script

          const xhr = new XMLHttpRequest();
          xhr.open("POST", url, true);
          xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

          xhr.onload = function() {
            if (xhr.status === 200) {
              alert("تم إرسال التحديثات إلى الشيت بنجاح.");
              console.log("تم إرسال التحديثات بنجاح: " + xhr.responseText);

              // حذف البيانات من الذاكرة المحلية بعد الإرسال
              localStorage.removeItem("ad");
              console.log("تم حذف البيانات من الذاكرة المحلية.");
            } else {
              console.error("حدث خطأ في الإرسال: " + xhr.status);
              alert("حدث خطأ في إرسال البيانات.");
            }
          };

          xhr.onerror = function() {
            console.error("حدث خطأ في إرسال الطلب.");
            alert("حدث خطأ في الاتصال.");
          };

          xhr.send(params); // إرسال البيانات
        }
      }
    }

    // دالة لتحديد ID المستخدم
    function setTelegramId() {
      // البحث عن ID في الذاكرة
      let id = localStorage.getItem("id");

      if (!id) {
        // إذا لم يتم العثور على ID، احصل على ID المستخدم من Telegram Mini App
        Telegram.WebApp.ready();
        id = Telegram.WebApp.initDataUnsafe.user.id;

        // حفظ ID في الذاكرة
        if (id) {
          localStorage.setItem("id", id);
          console.log("تم تعيين ID المستخدم: " + id);
        } else {
          console.error("لم يتم العثور على ID التلجرام.");
        }
      }
    }

    // عند تحميل الصفحة: بدء العداد وتعيين ID التلجرام
    window.onload = function() {
      setTelegramId();
      startCountdown();
    };
  </script>
</head>
<body>
  <h1>عداد تنازلي مع تخزين البيانات</h1>
  <div>
    <label for="ad">Ad:</label>
    <input type="text" id="ad" name="ad" required><br><br>
    <button onclick="saveToLocalStorage()">حفظ التحديثات في الذاكرة</button>
  </div>
  <div id="countdown">00:00:00</div>
  <div id="status" class="status"></div>
</body>
</html>
